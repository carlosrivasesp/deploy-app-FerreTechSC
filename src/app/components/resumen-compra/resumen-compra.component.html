<app-navbar-principal></app-navbar-principal>
<div class="spacer d-none d-md-block" style="height: 150px"></div>

<main class="main-content">
  <div class="side-decor left"></div>
  <div class="side-decor right"></div>

  <div class="resumen-compra-container container py-3">
    <h2 class="resumen-titulo mb-4">
      <i class="fas fa-file-invoice me-2"></i> Resumen de Compra
    </h2>
    <!-- ✅ NOTIFICACIÓN DE ÉXITO -->
    <div
      *ngIf="pedidoExitoso"
      class="alert alert-success d-flex align-items-center shadow-sm"
      role="alert"
    >
      <i class="fas fa-check-circle me-3" style="font-size: 2rem"></i>
      <div>
        <h5 class="alert-heading mb-1">¡Pedido Registrado!</h5>
        <p class="mb-0">
          Tu pedido ha sido registrado correctamente. Gracias por tu compra.
        </p>
      </div>
    </div>
    <!-- ✅ FIN DE NOTIFICACIÓN -->

    <div *ngIf="cartItems.length > 0; else carritoVacio">
      <!-- Lista de productos -->
      <div
        class="carrito-item card shadow-sm p-3 mb-3"
        *ngFor="let item of cartItems"
      >
        <div class="row align-items-center">
          <div class="col-3 col-md-2 text-center">
            <!-- Asumiendo que 'item.producto.imagen' existe; si no, se usa un placeholder -->
            <img
              [src]="
                item.producto.imageUrl ||
                'https://placehold.co/100x100/f0f0f0/ccc?text=Producto'
              "
              onerror="this.src='https://placehold.co/100x100/f0f0f0/ccc?text=Error'"
              class="img-fluid rounded"
              alt="{{ item.nombre }}"
              style="max-height: 80px; object-fit: cover"
            />
          </div>

          <div class="col-6 col-md-6">
            <h5 class="mb-1">{{ item.nombre }}</h5>
            <p class="mb-1 text-muted">
              <i class="fas fa-tag me-1"></i> Precio:
              <strong>S/ {{ item.precio | number : "1.2-2" }}</strong>
            </p>
            <p class="mb-0 text-muted">
              <i class="fas fa-calculator me-1"></i> Total:
              <strong
                >S/ {{ item.precio * item.cantidad | number : "1.2-2" }}</strong
              >
            </p>
          </div>

          <div class="col-12 col-md-4 text-center text-md-end botones-control">
            <div class="cantidad-stepper d-inline-flex align-items-center">
              <span class="cantidad-display">Cant: {{ item.cantidad }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Datos del cliente invitado -->
      <div class="card p-4 mt-4">
        <!-- ✅ Novedad: Título y botón Limpiar alineados -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">
            <i class="fas fa-user me-2"></i> Datos del Cliente
          </h5>
          <!-- ✅ Novedad: Botón para limpiar campos de cliente -->
          <button
            class="btn btn-outline-danger btn-sm"
            (click)="limpiarCamposCliente()"
            title="Limpiar todos los campos del cliente"
          >
            <i class="fas fa-eraser me-1"></i> Limpiar Campos
          </button>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="tipoDoc" class="form-label">Tipo de Documento</label>
            <!-- ACTUALIZADO: (change) y valor 'factura' -->
            <!-- ✅ Novedad: [disabled] para bloquear si el cliente existe -->
            <select
              id="tipoDoc"
              class="form-select"
              [(ngModel)]="tipoDoc"
              (change)="onTipoDocChange()"
              [disabled]="clienteBloqueado"
            >
              <option value="DNI">DNI</option>
              <option value="factura">Factura (RUC)</option>
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label for="nroDoc" class="form-label">Nro. de Documento</label>
            <!-- ACTUALIZADO: type="tel", pattern y [attr.maxlength] dinámico -->
            <!-- ✅ Novedad: [disabled] para bloquear si el cliente existe -->
            <input
              id="nroDoc"
              type="tel"
              pattern="[0-9]*"
              class="form-control"
              [(ngModel)]="nroDoc"
              (input)="onNroDocInput()"
              placeholder="Ej: 12345678"
              [class.is-invalid]="nroDocError"
              [attr.maxlength]="
                tipoDoc === 'DNI' ? 8 : tipoDoc === 'factura' ? 11 : null
              "
              [disabled]="clienteBloqueado"
            />
            <!-- ACTUALIZADO: Muestra el mensaje de error -->
            <div *ngIf="nroDocError" class="invalid-feedback d-block">
              {{ nroDocError }}
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="nombre" class="form-label">Nombre / Razón Social</label>
            <!-- ✅ Novedad: [readonly] para bloquear si el cliente existe -->
            <input
              id="nombre"
              type="text"
              class="form-control"
              [(ngModel)]="nombre"
              [readonly]="clienteBloqueado"
            />
          </div>

          <div class="col-md-6 mb-3">
            <label for="telefono" class="form-label">Teléfono</label>
            <!-- ✅ Novedad: [readonly] para bloquear si el cliente existe -->
            <input
              id="telefono"
              type="tel"
              class="form-control"
              [(ngModel)]="telefono"
              [readonly]="clienteBloqueado"
            />
          </div>

          <div class="col-md-6 mb-3">
            <label for="correo" class="form-label">Correo</label>
            <!-- ✅ Novedad: [readonly] para bloquear si el cliente existe -->
            <input
              id="correo"
              type="email"
              class="form-control"
              [(ngModel)]="correo"
              placeholder="ejemplo@correo.com"
              [readonly]="clienteBloqueado"
            />
          </div>

          <div class="col-12 mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="delivery"
                [(ngModel)]="servicioDelivery"
              />
              <label class="form-check-label" for="delivery">
                ¿Deseas servicio de delivery?
              </label>
            </div>
          </div>

          <div *ngIf="servicioDelivery" class="col-12">
            <div class="row">
              <div class="col-md-8 mb-3">
                <label for="direccion" class="form-label">Dirección</label>
                <input
                  id="direccion"
                  type="text"
                  class="form-control"
                  [(ngModel)]="direccion"
                />
              </div>
              <div class="col-md-4 mb-3">
                <label for="distrito" class="form-label">Distrito</label>
                <input
                  id="distrito"
                  type="text"
                  class="form-control"
                  [(ngModel)]="distrito"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <button
        class="btn btn-success w-100 mt-3"
        (click)="confirmarPedidoInvitado()"
      >
        <i class="fas fa-check me-2"></i> Registrar Pedido (Invitado)
      </button>
    </div>

    <!-- Carrito vacío -->
    <ng-template #carritoVacio>
      <div class="carrito-vacio card shadow-sm p-5 text-center">
        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
        <p class="fs-5 mb-2">Tu carrito está vacío.</p>
        <a routerLink="/catalogo" class="btn btn-outline-primary">
          <i class="fas fa-store me-2"></i> Ir al catálogo
        </a>
      </div>
    </ng-template>
  </div>
</main>
