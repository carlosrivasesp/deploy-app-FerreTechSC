<app-header />
<app-sidebar />

<main class="main-content">
    <div class="separador">
    <p class="title">Salida de productos</p>

    <div class="filter">
        <div class="group1">
            <p class="description">Filtrar por: </p>

            <div class="dropdown">
                <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {{ selectedFilter | titlecase}}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" (click)="selectedFilter = 'nro pedido'">Nro Pedido</a></li>
                    <li><a class="dropdown-item" (click)="selectedFilter = 'fecha salida'">Fecha Salida</a></li>
                </ul>
            </div>
        </div>

        <div class="group2">
            <div class="input-group">
                <input type="text" class="form-control" [(ngModel)]="searchTerm" placeholder="Buscar">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
        </div>

        <div class="group3">
          <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#modalAdd"
            (click)="resetFormulario()" style="background-color: #10401b;">
            <i class="bi bi-plus" style="color: aliceblue;"></i>
          </button>
        </div>

    </div>

    <table class="table">
        <thead>
            <tr class="header">
                <th scope="col" style="width: 200px;">Tipo OperaciÃ³n</th>
            <th scope="col" style="width: 250px;">Nro Pedido</th>
            <th scope="col" style="width: 150px;">Cantidad Total</th>
            <th scope="col" style="width: 150px;">Fecha de Salida</th>
            <th scope="col" style="width: 80px;">Acciones</th>
            </tr>
        </thead>
        <tbody class="body">
            <tr *ngFor="let salida of paginated">
                <td>{{ salida.tipoOperacion }}</td>
                <td>{{ salida.pedidoId.nroOperacion }}</td>
                <td>{{ salida.cantidadTotal }}</td>
                <td>{{ salida.fechaSalida ? (salida.fechaSalida | date: 'dd/MM/yyyy') : 'Sin fecha' }}</td>
                <td>
                  <div class="links">
                    <a
                      class="actions"
                      role="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      data-bs-toggle="modal"
                      data-bs-target="#modalDetalles"
                      (click)="verDetalles(salida)"
                    >
                      <i class="bi bi-eye"></i>
                    </a>
                  </div>
                  </td>
            </tr>
        </tbody>
    </table>

    <nav *ngIf="totalPages > 1" class="mt-3" aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="changePage(currentPage - 1)">Anterior</a>
          </li>
          <li class="page-item"
              *ngFor="let page of [].constructor(totalPages); let i = index"
              [class.active]="currentPage === i + 1">
            <a class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="changePage(currentPage + 1)">Siguiente</a>
          </li>
        </ul>
      </nav>

</div>
</main>

<div class="modal fade modal-xl" id="modalAdd" tabindex="-1" aria-labelledby="modalAdd" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- ðŸ”¹ Encabezado -->
      <div class="modal-header">
        <h1 class="modal-title fs-5">Registrar Salida</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- ðŸ”¹ Cuerpo del modal -->
      <div class="modal-body">
        <form [formGroup]="salidaForm" (ngSubmit)="registrarSalida()">
          
          <!-- ðŸ”¸ SelecciÃ³n de pedido -->
          <div class="mb-3">
            <label class="form-label">Pedido (solo Enviados)</label>
            <select
              class="form-select"
              formControlName="pedidoId"
              (change)="onPedidoChange($event)"
            >
              <option value="">Seleccione un pedido</option>
              <option *ngFor="let p of pedidosEnviados" [value]="p._id">
                NÂ° {{ p.nroOperacion }} - {{ p.cliente.nombre }}
              </option>
            </select>

            <div class="text-danger mt-1" *ngIf="salidaForm.get('pedidoId')?.touched && salidaForm.get('pedidoId')?.hasError('required')">
              Debe seleccionar un pedido.
            </div>
          </div>

          <!-- ðŸ”¸ Tabla de detalles -->
          <div formArrayName="detalles" *ngIf="detalles.controls.length > 0; else noPedido">
            <table class="table table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th>Cant. Pedido</th>
                  <th>Cant. Salida</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let det of detalles.controls; let i = index" [formGroupName]="i">
                  <td>{{ det.get('producto')?.value }}</td>
                  <td>{{ det.get('cantidadPedido')?.value }}</td>
                  <td>
                    <input
                      type="number"
                      min="1"
                      class="form-control"
                      formControlName="cantidadSalida"
                      (input)="calcularCantidadTotal()"
                    />
                    <div *ngIf="det.get('cantidadSalida')?.hasError('max')" class="text-danger small">
                      No puede exceder la cantidad pedida.
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ðŸ”¸ Mensaje si no hay pedido seleccionado -->
          <ng-template #noPedido>
            <div class="alert alert-info text-center mt-3">
              Seleccione un pedido para mostrar los productos.
            </div>
          </ng-template>

          <!-- ðŸ”¸ Cantidad total -->
          <div class="mt-3">
            <label class="form-label fw-bold">Cantidad Total:</label>
            <input
              class="form-control"
              formControlName="cantidadTotal"
              readonly
            />
          </div>

          <!-- ðŸ”¸ Fecha de salida -->
          <div class="mt-3">
            <label class="form-label fw-bold">Fecha de Salida:</label>
            <input
              type="date"
              class="form-control"
              formControlName="fechaSalida"
            />
            <div class="text-danger mt-1" *ngIf="salidaForm.get('fechaSalida')?.touched && salidaForm.get('fechaSalida')?.hasError('required')">
              La fecha de salida es obligatoria.
            </div>
            <div *ngIf="salidaForm.get('fechaSalida')?.hasError('fechaFutura')" class="text-danger mt-1">
              La fecha no puede ser posterior al dÃ­a actual.
            </div>
          </div>

          <!-- ðŸ”¹ Footer con acciones -->
          <div class="modal-footer mt-4">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>

            <button
              type="submit"
              class="btn btn-success"
              [disabled]="salidaForm.invalid"
              data-bs-dismiss="modal"
            >
              Registrar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade modal-lg"
  id="modalDetalles"
  tabindex="-1"
  aria-labelledby="modalDetalles"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalles de la Salida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" *ngIf="salidaSeleccionada">
        <p><strong>Tipo de OperaciÃ³n:</strong> {{ salidaSeleccionada.tipoOperacion }}</p>
        <p><strong>NÂ° Pedido:</strong> {{ salidaSeleccionada.pedidoId.nroOperacion }}</p>
        <p><strong>Cliente:</strong> {{ salidaSeleccionada.pedidoId.cliente.nombre }}</p>
        <p><strong>Fecha de Salida:</strong> {{ salidaSeleccionada.fechaSalida | date:'dd/MM/yyyy' }}</p>
        <p><strong>Cantidad Total:</strong> {{ salidaSeleccionada.cantidadTotal }}</p>

        <hr />

        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th>Cantidad Salida</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of salidaSeleccionada.detalles">
              <td>{{ d.detalleId.producto.nombre }}</td>
              <td>{{ d.cantidadSalida }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>